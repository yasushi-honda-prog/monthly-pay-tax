"""ヘルプ / マニュアル"""

import streamlit as st

st.header("ヘルプ")


# --- 概要 ---
st.subheader("ダッシュボードについて")
st.markdown("""
このダッシュボードは、約190名のメンバーの月次報酬データをBigQueryから取得して可視化するツールです。
データは毎朝6時に自動収集されます（前日までのデータが反映）。
""")


# --- ページガイド ---
st.subheader("ページ一覧")

st.markdown("""
| ページ | 説明 | アクセス権 |
|:---|:---|:---|
| **ダッシュボード** | 月別報酬サマリー、スポンサー別業務委託費、業務報告一覧の3タブ | 全ユーザー |
| **アーキテクチャ** | システム構成図、データフロー、BQスキーマの技術ドキュメント | 全ユーザー |
| **ヘルプ** | このページ。使い方・用語集・FAQ | 全ユーザー |
| **ユーザー管理** | ダッシュボードのアクセス権管理 | 管理者のみ |
| **管理設定** | キャッシュ制御・システム情報 | 管理者のみ |
""")


# --- フィルター使用方法 ---
st.subheader("フィルターの使い方")

st.markdown("""
ダッシュボードページの左サイドバーにフィルターがあります。

**期間フィルター**
- 「年度」で対象年を選択（デフォルト: 最新年）
- 「月」で対象月を選択（「全月」で年間表示）

**メンバーフィルター**
- テキストボックスで名前を絞り込み
- チェックボックスで個別選択
- 「全選択」「全解除」ボタンで一括操作
- 未選択時は全メンバーのデータを表示

**タブ内フィルター**
- スポンサー別タブ: スポンサーで絞り込み
- 業務報告一覧タブ: 活動分類で絞り込み
""")


# --- 用語集 ---
st.subheader("データ用語集")

st.markdown("""
| 用語 | 説明 |
|:---|:---|
| **業務報酬** | 時間報酬 + 距離報酬の合計に役職手当率・資格手当を適用した金額 |
| **時間報酬** | 業務時間 × 単価で計算された報酬 |
| **距離報酬** | 自家用車使用時の移動距離に対する報酬 |
| **役職手当率** | メンバーの役職に応じた報酬加算率（%）|
| **資格手当** | 特定資格保有者への固定加算額 |
| **源泉徴収** | 源泉対象額 × 10.21% を控除（法人・寄付シートは免除）|
| **DX補助** | デジタル化推進のための補助金 |
| **立替** | メンバーが立て替えた経費の精算額 |
| **支払い** | 業務報酬 + 源泉徴収（マイナス） + DX補助 + 立替 |
| **寄付支払い** | 寄付先シートに紐づくメンバーの報酬（別会計） |
| **1立て** | 日給制の業務。全日稼働(6h) / 半日稼働(3h) の固定時間で計上 |
| **総稼働時間** | 通常の業務時間 + 1立ての固定時間を合算した合計 |
""")


# --- FAQ ---
st.subheader("よくある質問")

with st.expander("データはいつ更新されますか？"):
    st.markdown("""
    毎朝6時（JST）にCloud Schedulerが自動でバッチ処理を実行します。
    約190件のスプレッドシートを巡回するため、処理には約4分かかります。
    ダッシュボードのデータは1時間キャッシュされるため、最新データの反映には最大1時間のラグがあります。
    """)

with st.expander("統計分析スプレッドシートと数値が異なります"):
    st.markdown("""
    統計分析スプレッドシートはIMPORTRANGE経由のライブデータを使用していますが、
    BQは毎朝6時のスナップショットです。データの鮮度の違いにより差異が生じることがあります。

    また、一部のカラム定義（例: 「報酬」列）はSSとBQで計算方法が異なる場合があります。
    """)

with st.expander("アクセス権限を追加してほしい"):
    st.markdown("""
    管理者（admin）に依頼してください。
    管理者は「ユーザー管理」ページからメールアドレスを登録できます。
    対象はtadakayo.jpドメインのGWSアカウントのみです。
    """)

with st.expander("データが表示されません"):
    st.markdown("""
    以下を確認してください:
    1. サイドバーのフィルター設定（年度・月・メンバー選択）
    2. 該当期間にデータが存在するか
    3. それでも解決しない場合は管理者にお問い合わせください
    """)
